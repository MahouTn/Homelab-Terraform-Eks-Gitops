pipeline {
    agent {
        kubernetes {
            yaml '''
kind: Pod
metadata:
  name: kaniko-builder
  namespace: ci-cd
spec:
  serviceAccountName: kaniko-sa
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.23.2-debug
    command:
      - /busybox/sh
      - -c
      - "tail -f /dev/null"
    tty: true
    env:
      - name: AWS_SDK_LOAD_CONFIG
        value: "true"
  - name: git
    image: alpine/git:latest
    command:
      - cat
    tty: true
'''
            defaultContainer 'kaniko'
        }
    }

    environment {
        IMAGE_REGISTRY = '802617578034.dkr.ecr.eu-west-1.amazonaws.com/homelab-eks'
        APP_PATH = "${WORKSPACE}/app-code/nodejs-demoapp"
        HELM_APP_PATH = "${WORKSPACE}/k8s/Application/nodejs-demoapp"
    }

    stages {
        stage('Build and Push Docker Image') {
            steps {
                container('kaniko') {
                    script {
                        IMAGE_TAG = "${GIT_COMMIT}"
                        IMAGE_FULL_URI = "${IMAGE_REGISTRY}:${IMAGE_TAG}"

                        sh """
                        /kaniko/executor \
                            --context=${APP_PATH}/build \
                            --dockerfile=${APP_PATH}/Dockerfile \
                            --destination=${IMAGE_FULL_URI}
                        """
                    }
                }
            }
        }

        stage('Update Helm values.yaml and Push') {
            steps {
                container('git') {
                    script {
                        withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                            sh """
                            git config user.name "MahouTn"
                            git config user.email "ayoub.mahoutn@gmail.com"
                            git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@github.com/MahouTn/Homelab-Terraform-Eks-Gitops.git

                            sed -i "s|tag:.*|tag: ${IMAGE_TAG}|g" ${HELM_APP_PATH}/values.yaml

                            git add ${HELM_APP_PATH}/values.yaml
                            git commit -m "Update image tag to ${IMAGE_TAG}"
                            git push origin main
                            """
                        }
                    }
                }
            }
        }
    }
}
