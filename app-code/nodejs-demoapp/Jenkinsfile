pipeline {
    agent {
        kubernetes {
            namespace 'ci-cd'
            serviceAccount 'kaniko-sa' // Make sure this SA has IRSA permissions for ECR
            containerTemplates([
                containerTemplate(
                    name: 'docker',
                    image: 'docker:24-dind',       // Docker-in-Docker image
                    privileged: true,              // Required for DinD
                    command: 'dockerd-entrypoint.sh',
                    args: '--host=tcp://0.0.0.0:2375 --host=unix:///var/run/docker.sock'
                )
            ])
            label 'docker-agent'
        }
    }

    environment {
        IMAGE_FULL_URI = '802617578034.dkr.ecr.eu-west-1.amazonaws.com/homelab-eks:latest'
        AWS_DEFAULT_REGION = 'eu-west-1'
    }

    stages {
        stage('Build and Push Image') {
            steps {
                container('docker') {
                    sh '''
                    # Login to ECR using IRSA (AWS CLI should be available in the container)
                    aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin 802617578034.dkr.ecr.eu-west-1.amazonaws.com

                    # Build Docker image
                    docker build -t homelab-eks:latest ${WORKSPACE}/deploy

                    # Tag image for ECR
                    docker tag homelab-eks:latest $IMAGE_FULL_URI

                    # Push image to ECR
                    docker push $IMAGE_FULL_URI
                    '''
                }
            }
        }
    }
}
