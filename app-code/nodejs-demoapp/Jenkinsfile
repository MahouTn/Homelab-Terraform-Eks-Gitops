pipeline {
    agent {
        kubernetes {
            yaml '''
kind: Pod
metadata:
  name: kaniko-builder
  namespace: ci-cd
spec:
  serviceAccountName: kaniko-sa
  volumes:
    - name: workspace-volume
      emptyDir: {}
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.23.2-debug
    command:
      - /busybox/sh
      - -c
      - "tail -f /dev/null"
    tty: true
    volumeMounts:
      - name: workspace-volume
        mountPath: /workspace
    env:
      - name: AWS_SDK_LOAD_CONFIG
        value: "true"
  - name: git
    image: alpine/git:latest
    command:
      - cat
    tty: true
    volumeMounts:
      - name: workspace-volume
        mountPath: /workspace
'''
            defaultContainer 'kaniko'
        }
    }

    environment {
        IMAGE_REGISTRY = '802617578034.dkr.ecr.eu-west-1.amazonaws.com/homelab-eks'
        APP_PATH = "${WORKSPACE}/app-code/nodejs-demoapp"
        HELM_APP_PATH = "${WORKSPACE}/k8s/Application/nodejs-demoapp"
        IMAGE_TAG = "${GIT_COMMIT}"  // Use commit SHA as tag
        IMAGE_FULL_URI = "${IMAGE_REGISTRY}:${IMAGE_TAG}"
    }

    stages {
        stage('Checkout Repository') {
            steps {
                container('kaniko') {
                    checkout scm
                }
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                container('kaniko') {
                    sh """
                    /kaniko/executor \
                        --context=${APP_PATH}/build \
                        --dockerfile=./Dockerfile \
                        --destination=${IMAGE_FULL_URI}
                    """
                }
            }
        }

        stage('Update Helm Chart and Push') {
            steps {
                container('git') {
                    script {
                        withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                            sh """
                            cd /workspace
                            git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/MahouTn/Homelab-Terraform-Eks-Gitops.git
                            cd Homelab-Terraform-Eks-Gitops

                            # Update Helm chart values.yaml
                            sed -i "s|tag:.*|tag: ${GIT_COMMIT}|g" k8s/Application/nodejs-demoapp/values.yaml

                            git config user.name "Jenkins"
                            git config user.email "jenkins@yourdomain.com"

                            git add k8s/Application/nodejs-demoapp/values.yaml
                            git commit -m "Update image tag to ${GIT_COMMIT}" || echo "No changes to commit"
                            git push origin main || echo "Nothing to push"
                            """
                        }
                    }
                }
            }
        }
    }
}
